{% macro render_messages(messages) %}
    {% for msg in messages %}
**{{ msg.timestamp | format_timestamp }}** {{ msg.user.name }}:
{{ msg.text }}

    {% endfor %}
{% endmacro %}
{% if workspace_long_term_memory %}
## ワークスペースの概要
{{ workspace_long_term_memory }}

{% endif %}
{% if channel_memories %}
## 各チャンネルの最近の出来事

    {% for channel in channel_memories.values() %}
        {% if channel.short_term_memory %}
### #{{ channel.channel_name }}
{{ channel.short_term_memory }}

        {% endif %}
    {% endfor %}
{% endif %}
## 現在の会話

現在は、#{{ current_channel_name }} チャンネルにいます。
直近の会話は以下の通りです。

{% if target_thread_ts %}
### トップレベル

{{ render_messages(top_level_messages) }}
{% endif %}
{% for thread_ts, thread_msgs in thread_messages.items() %}
    {% if target_thread_ts and thread_ts != target_thread_ts %}
### スレッド: {{ thread_ts }}

{{ render_messages(thread_msgs) }}
    {% endif %}
{% endfor %}
{% if target_thread_ts %}
### 返信対象スレッド: {{ target_thread_ts }}

{{ render_messages(target_thread_messages) }}
{% else %}
### 返信対象: トップレベル

{{ render_messages(top_level_messages) }}
{% endif %}
---
{% if target_thread_ts %}
上記の情報をもとに、返信対象スレッドに返答してください。
{% else %}
上記の情報をもとに、返信対象メッセージに返答してください。
{% endif %}

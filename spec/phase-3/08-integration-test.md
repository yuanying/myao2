# 08: 統合テスト・動作確認

## 目的

Phase 3 の全コンポーネントが正しく連携することを確認する。

---

## テストの分類

### 自動テスト

各コンポーネントの単体テストは各タスクで実装済み。
ここでは統合テストの設計を行う。

### 手動テスト

実際の Slack 環境での動作確認手順を定義する。

---

## 自動テスト（統合）

### テストファイル

| ファイル | 説明 |
|---------|------|
| `tests/integration/test_autonomous_response_flow.py` | 自律応答フローの統合テスト |

### 統合テストシナリオ

| テスト | シナリオ | 期待結果 |
|--------|---------|---------|
| 正常フロー | 未応答メッセージあり、判定True | 応答が送信・保存される |
| 判定却下 | 未応答メッセージあり、判定False | 応答は送信されない |
| 複数チャンネル | 2チャンネルに未応答メッセージ | 両方チェックされる |
| 定期実行 | 2回のチェック | 2回ともユースケースが実行される |

### モック構成

```
[テスト]
    │
    ├─> ChannelMonitor（モック）
    │   └─> 固定のメッセージを返す
    │
    ├─> ResponseJudgment（モック）
    │   └─> 固定の判定結果を返す
    │
    ├─> ResponseGenerator（モック）
    │   └─> 固定の応答を返す
    │
    ├─> MessagingService（モック）
    │   └─> 送信を記録
    │
    └─> MessageRepository（インメモリ）
        └─> 保存を記録
```

---

## 手動テスト

### 準備

1. テスト用 Slack ワークスペース
2. ボットをチャンネルに招待
3. config.yaml の設定確認

```yaml
response:
  enabled: true
  check_interval_seconds: 60
  min_wait_seconds: 300  # テスト時は短くしてもよい
```

### 検証手順

#### ケース 1: 未応答メッセージへの自律応答

1. チャンネルでメッセージを投稿（メンションなし）
2. 誰も返信しない状態で min_wait_seconds 以上待機
3. ボットが自律的に応答することを確認
4. ログで判定理由を確認

```
期待結果:
- ボットが自律的にメッセージを送信
- ログに「判定結果: should_respond=True, reason=...」が出力
```

#### ケース 2: 活発な会話への不介入

1. チャンネルで複数人が活発に会話
2. ボットが割り込まないことを確認
3. ログで判定理由を確認

```
期待結果:
- ボットはメッセージを送信しない
- ログに「判定結果: should_respond=False, reason=...」が出力
```

#### ケース 3: メンション応答との共存

1. ボットにメンションを送信
2. 即座にメンション応答が返ることを確認
3. 自律応答とは別の動作であることを確認

```
期待結果:
- メンション応答は即座に返る
- 自律応答の待機時間には影響しない
```

#### ケース 4: 定期チェックの動作確認

1. アプリケーションを起動
2. ログで check_interval_seconds ごとにチェックが実行されることを確認

```
期待結果:
- ログに「定期チェック開始」「定期チェック完了」が定期的に出力
```

#### ケース 5: グレースフルシャットダウン

1. アプリケーションを起動
2. Ctrl+C で終了
3. 「シャットダウン中...」のログが出力されることを確認

```
期待結果:
- 即座にクラッシュせず、グレースフルに終了
- ログに「定期チェック停止」が出力
```

---

## 動作確認チェックリスト

### 基本動作

- [ ] アプリケーションが正常に起動する
- [ ] Socket Mode が接続される
- [ ] 定期チェックが開始される

### 自律応答

- [ ] 未応答メッセージが検出される
- [ ] LLM による応答判定が実行される
- [ ] 判定結果に基づいて応答が送信される
- [ ] 送信したメッセージが保存される

### 設定

- [ ] response.enabled=false で定期チェックが無効化される
- [ ] check_interval_seconds が正しく適用される
- [ ] min_wait_seconds が正しく適用される
- [ ] llm.judgment 設定が使用される

### エラーハンドリング

- [ ] 個別チャンネルのエラーで全体が停止しない
- [ ] LLM エラーで次のメッセージ処理が継続される
- [ ] Slack API エラーがログに記録される

### シャットダウン

- [ ] Ctrl+C でグレースフルに終了する
- [ ] 処理中のタスクが完了してから終了する

---

## トラブルシューティング

### 自律応答が発生しない

1. response.enabled が true か確認
2. min_wait_seconds が経過しているか確認
3. ログで判定結果を確認
4. ボットがチャンネルに参加しているか確認

### 判定が常に False になる

1. llm.judgment の設定を確認
2. プロンプトの内容を確認
3. LLM のレスポンスをデバッグログで確認

### 定期チェックが実行されない

1. check_interval_seconds の値を確認
2. エントリポイントのログを確認
3. asyncio タスクが正常に起動しているか確認

---

## 完了基準

- [ ] 統合テストが設計されている
- [ ] 手動テスト手順が定義されている
- [ ] 動作確認チェックリストが作成されている
- [ ] トラブルシューティングガイドが作成されている
- [ ] 全ての手動テストケースがパスする
